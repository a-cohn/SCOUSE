================================================================================
SCOUSE TUTORIAL                                                              
================================================================================

About
=====

This tutorial demonstrates how SCOUSE can be used to fit spectral line data. It
makes the assumption that the SCOUSE libraries (and other dependencies) have
been downloaded and added to your IDL_PATH.

If you wish, you can take a look at exactly what I entered during the fitting
procedure in the log files in the 'MISC' directory generated by SCOUSE. In total
it took < 5 minutes for me to fit the tutorial data.

Data
====

This tutorial utilises observations of N2H+ (1-0) towards the Infrared Dark
Cloud G035.39-00.33. This data set was first published in Henshaw et al. 2013.
These observations were carried out with the IRAM 30m Telescope. IRAM is
supported by INSU/CNRS (France), MPG (Germany) and IGN (Spain).

Initial considerations
======================

SCOUSE requires a .fits file as input. The spectral axis should be in velocity.
The parameter 'vunit' (see SCOUSE stage 1) should be altered depending on the
units.

**NOTE** For this particular data I have used offset right ascension and
declination. To do this, I have added the option /OFFSETS to the function
'file_read':

image  = FILE_READ( datadirectory, fitsfile, x=x_axis, y=y_axis, z=z_axis, header=HDR_DATA, /OFFSETS )

This needs to be done for stages 1, 2, 3, 5, 6. Depending on your data you may
wish to do this as well. However, if you do, take a look at the file_read
function as it requires a reference location (see create_offsets). In the
tutorial data, the reference location is under 'RA' and 'DEC' in the FITS
header, but this is likely to be data specific.

Main stages
===========

STAGE 1
=======

Stage 1 is designed to reduce the workload. During a manual fitting process, all
spectra have to be checked. Conversely, the role of stage 1 of SCOUSE is to
focus this effort.

The first step of the process is to create an integrated-intensity map of the
emission. To do this the user must provide the minimum and maximum extent of the
region they would like to cover in position-position-velocity space, an estimate
for the spectral rms noise, and a threshold level above which the emission is
considered to be significant.

A grid of regions with radius, R_saa, spaced by R_saa/2 is constructed to cover
the full extent of the integrated emission. These regions we refer to as
"spectral averaging areas" (SAA). All SAAs where > 50 % of the enclosed pixels
have non-significant integrated emission are rejected from the fitting
procedure.

The remaining SAAs define the "coverage" - the region over which we are going to
perform the fitting procedure.

For the tutorial data:

;------------------------------------------------------------------------------;  
; USER INPUT  
;------------------------------------------------------------------------------;  

datadirectory =  'data directory'    
filename      =  'n2h+10_37'      ; The data cube to be analysed  
fitsfile      =  filename+'.fits' ; fits extension  
vlower        =  32.0             ; The lower limit to the velocity  
vupper        =  42.0             ; The upper limit to the velocity  
xlower        = -1000.0           ; The lower limit to the x dimension  
xupper        =  1000.0           ; The upper limit to the x dimension  
ylower        = -1000.0           ; The lower limit to the y dimension  
yupper        =  1000.0           ; The upper limit to the y dimension  
rsaa          =  40.0             ; Radius for the spectral averaging areas. Map units.  
rms_approx    =  0.1              ; Enter an approximate rms value for the data.  
sigma_cut     =  3                ; Threshold below which all channel values set to 0.0  
vunit         =  1000.0           ; if FITS header has units of m/s; conv from m/s to km/s  

;------------------------------------------------------------------------------;  

Here, vlower and vupper have been set such that we only focus on the isolated
hyperfine component of the N2H+ (1-0) data. More generally this is a useful
step - it may help the user to pick out features which they otherwise wouldn't,
if the fitting process was implemented over the full bandwidth. It is therefore
worthwhile to have an idea of the velocity range covered by the emission prior
to commencing the SCOUSE process.

The remaining limits are set to "(-)1000" to indicate that we want to fit the
whole map. If however, you wish to focus only on a particular region of a larger
map, the limits can be set accordingly. I have set Rsaa to 40". These input
values generate the following output:

Number of spectra to fit manually:       19.0000  
Number of spectra:                       126.000  

As well as the SCOUSE directory structure which can be found in 'data
directory':

SCOUSE file structure:  

FILENAME  
  FIGURES  
  MISC  
  STAGE_1  
    COVERAGE  
    MOMENTS  
  STAGE_2  
    SAA_FIGURES  
    SAA_RESIDUALS  
    SAA_SOLUTIONS  
  STAGE_3  
    INDIV_RESIDUALS  
    INDIV_SOLUTIONS  
  STAGE_4  
  STAGE_5  
  STAGE_6  
  STAGE_7  

A figure displaying the coverage is created:  

'filename/STAGE_1/COVERAGE/coverage.eps'  

This can be used as a guide to tweak the input parameters if necessary. The
zeroth, first, and second order moments are also generated and provided both in
text and FITS format in:

'filename/STAGE_1/MOMENTS/'  

STAGE 2
=======

;------------------------------------------------------------------------------;  
; USER INPUT  
;------------------------------------------------------------------------------;  

datadirectory = 'data directory'    
filename      = 'n2h+10_37'       ; The data cube to be analysed  
fitsfile      = filename+'.fits'  ; fits extension  
vunit         = 1000.0            ; if FITS header has units of m/s; conv from m/s to km/s  

;------------------------------------------------------------------------------;  

The fitting process. This stage is user interactive. For the tutorial data,
using the above input parameters to stage 1 will result in having to fit 19
spectra. Each spectrum to be fit represents a spatially-averaged spectrum
extracted from a SAA.

Upon running the code the user will be asked:

*"Would you like to choose a new rms window?"*

If this is the first spectrum then it is important to define an rms window. For
all subsequent spectra if this option is not selected SCOUSE will use the window
that was last defined (pressing the return key is sufficient - no need to type
"no").

SCOUSE will also present the *full* spectrum (not just that defined by vupper
and vlower in stage 1). The user should try to select a large portion of the
line-free data. For the tutorial data I select:

Enter lower window limit (km s-1): 10  
Enter upper window limit (km s-1): 30  

This window will be shown on the spectrum. If the user is happy SCOUSE will
move on to fitting the spectra, if not, the window can be redefined.

The next step is the fitting procedure. The user will be first asked to enter
the number of Gaussians to fit. You are then required to enter estimates for
the intensity, centroid velocity, and line-width. **You do not have to be super
accurate with the estimates**. I find that so long as the velocity is ball-park
then mpfit will find the best-fitting solution. As an example, for the
tutorial data I will typically enter '1' and '1' for the intensity and
line-width and then an integer value for the velocity. Only when I am having
issues with getting a good fit do I refine the estimates. This speeds up the
process considerably.

Following the fitting process the best fitting solutions can be found in:

'filename/STAGE_2/SAA_SOLUTIONS/SAA_solutions.dat'

The output file is organised into the following columns:

1. The number of gaussians fit
2. X position
3. Y position
4. Peak intensity
5. Uncertainty
6. Centroid velocity
7. Uncertainty
8. FWHM line-width
9. Uncertainty
10. Spectral rms
11. Residual
12. Chi-squared value
13. Number of degrees of freedom
14. Reduced Chi-squared
15. Akaike Information Criterion (AIC) value
16. Spectral rms window lower
17. Spectral rms window upper

STAGE 3
=======

;------------------------------------------------------------------------------;  
; USER INPUT; CONDITIONAL VALUES - SEE HENSHAW+ 2015  
;------------------------------------------------------------------------------;  

datadirectory = 'data directory'    
filename      = 'n2h+10_37'       ; The data cube to be analysed  
fitsfile      = filename+'.fits'  ; fits extension  
vunit         = 1000.0            ; if FITS header has units of m/s; conv from m/s to km/s  
T1            = 5.0               ; * RMS - minimum intensity of components  
T2            = 3.0               ; * vel res - minimum width of components  
T3            = 3.0               ; Difference in dispersion from relevant component in SAA fit  
T4            = 1.5               ; Difference in velocity from relevant component in SAA fit  
T5            = 0.5               ; Difference in velocity between adjacent components (in units of FWHM)  
velo_res      = 0.07              ; Velocity resolution  

;------------------------------------------------------------------------------;  

This code controls the automated fitting procedure. It takes the best-fitting
solutions to the SAAs which were extracted in Stage 2, and uses these as input
estimates to all composite spectra within the relevant SAA.

These input parameters are data dependent. I typically will run stages 3, 4 and
5 in quick succession to take a look at the quality of the best-fitting
solutions (stage 5), then will return to stage 3 to tweak the parameters
accordingly.

STAGE 4
=======

;------------------------------------------------------------------------------;  
; USER INPUT  
;------------------------------------------------------------------------------;  

datadirectory = 'data directory'    
filename      = 'n2h+10_37'      ; The data cube to be analysed  
fitsfile      = filename+'.fits' ; fits extension  

;------------------------------------------------------------------------------;  

This is where the best-fitting solutions are selected. Nothing has to be done
here as the process is fully-automated.

STAGE 5
=======

Stage 5 serves a couple of purposes. Firstly, I will use this to quickly check
the best-fitting solutions to the spectra. If necessary I will tune the input
parameters in stage 3 and repeat stages 4 and 5. Secondly, once the user is
happy with the input parameters to stage 3, stage 5 is used to enter the indices
of spectra for which the user would like to revisit the best-fitting solution.
This may be due to an obviously poor fit, or simply because the user, given the
context of the surrounding spectra, may wish to see if an alternative solution
is available.

Although stage 5 is optional, I would always recommend checking the best-fitting
solutions to the data. This is true *irrespective* of the method chosen to fit
the data. Unfortunately, when you have a significant amount of spectra there is
no easy way to do this.

;------------------------------------------------------------------------------;  
; USER INPUT  
;------------------------------------------------------------------------------;  

datadirectory = 'data directory'    
filename      = 'n2h+10_37'                                                 ; The data cube to be analysed                                             fitsfile      = filename+'.fits'                                            ; fits extension  
vunit         = 1000.0                                                        
velrange      = [32.0, 42.0]                                                ; range over which to plot spectra  
SolnFile      = datadirectory+filename+'/STAGE_4/final_solns.dat'           ;  
OutFile       = datadirectory+filename+'/STAGE_5/check_spec_indxfile_1.dat' ; **This needs to be updated**  
JOURNAL,        datadirectory+filename+'/MISC/stagefive_1_log.dat'          ; **This needs to be updated**  
val           = 49.0                                                        ; 36/49 spectra at a time is reasonable.  
grid_dim      = 7                                                           ; This will plot a 7x7 grid  
nblocks       = NUMBLOCKS( datadirectory, filename, val )  
lower_block   = 0                                                           ; lower block index  
upper_block   = nblocks                                                     ; upper block index.  

;------------------------------------------------------------------------------;  

After running stage 5, the user will be presented with a block of spectra. For
the tutorial data I have set the velocity range once again to 32.0-42.0 km/s.
This is the range over which the spectra will be plotted. The parameter 'val'
indicates the number of spectra in one 'block' - I find that checking a 7 x 7
grid works for me.

The user is able to control how many blocks are checked at any one time. In the
case of the tutorial data there are 126 spectra (3 blocks). This can easily be
done in one sitting. However, I wouldn't recommend doing this when you have
~10000 spectra. Here I prefer to check ~ 50 blocks (2450 spectra) at a time,
which is (slightly) less painful. To do this you should use the 'lower_block'
and 'upper_block' parameters. **Additionally, the 'Outfile' and 'JOURNAL' files
should be given unique names for each block, otherwise they will be
overwritten.**

The process itself should be pretty straight-forward. Just enter the index of
the spectrum you would like to revisit and enter '-1' when you are finished with
a block.

Using the input parameters I selected in stage 3 led me to selecting the
following positions for a closer look.

31.47731      7.99993      0.00000     10.00000     10.00000  
18.48667   -121.99999      1.00000      0.00000     21.00000  
18.48667   -109.00000      1.00000      1.00000     22.00000  
 5.49604    124.99986      2.00000     19.00000     61.00000  
 5.49604    137.99985      2.00000     20.00000     62.00000  
-7.49459    124.99986      3.00000     19.00000     82.00000  
-7.49459    137.99985      3.00000     20.00000     83.00000  
-20.48522    137.99985      4.00000     20.00000    104.00000  

STAGE 6
=======

**This stage reads in the file:

'datadirectory+filename+'/STAGE_5/check_spec_indxfile.dat'

as input. So if you have named the 'outfile' something else in stage 5, or if
you have checked the spectra in groups (each with a unique file), the indices
should be collected into a single file.**

This stage is where we take a closer look at those spectra identified during
stage 5.

;------------------------------------------------------------------------------;  
; USER INPUT  
;------------------------------------------------------------------------------;  

datadirectory = 'data directory'    
filename      = 'n2h+10_37'                                                   ; The data cube to be analysed  
fitsfile      = filename+'.fits' ; fits extension  
vunit         = 1000.0                                                          
velrange      = [32.0, 42.0]                                                  ; range over which to plot spectra  
IndxFile      = datadirectory+filename+'/STAGE_5/check_spec_indxfile.dat'     ;  
OutFile       = datadirectory+filename+'/STAGE_6/alternative_solutions_1.dat' ; **This needs to be updated**  
JOURNAL,        datadirectory+filename+'/MISC/stagesix_1_log.dat'             ; **This needs to be updated**  
nlines        = NUMLINES(IndxFile)  
nlower        = 0                                                             ; Lower spectrum index  
nupper        = nlines-1                                                      ; Upper spectrum index  

;------------------------------------------------------------------------------;  

The code will go through each spectrum selected in stage 5. Once again, if there
is a significant number of spectra to check, I would break the process into
smaller tasks using the 'nlower' and 'nupper' parameters. I find that checking
the spectra in blocks of 50 or 100 works. **However, once again remember to give
each block a unique filename**.

As with stage 5, this process is user interactive. The program will cycle
through all of the spectra identified in stage 5. For each spectrum, the current
solution, as well as all available alternatives is displayed. Alternative
solutions are available since the SAAs are spaced by R_saa/2.  

To retain the current solution: Enter '-1'  
To choose an alternative:       Choose one of a,b,c,d...  
To refit entirely:              Enter nothing  

If the user enters nothing and decides to refit, the refitting process will
begin immediately.

For the positions selected in stage 5 I selected the following options:

31.47731      7.99993      alternative solution b  
18.48667   -121.99999      alternative solution a  
18.48667   -109.00000      refit manually  
 5.49604    124.99986      refit manually  
 5.49604    137.99985      refit manually  
-7.49459    124.99986      retain current solution  
-7.49459    137.99985      refit manually  
-20.48522    137.99985     refit manually  

This produces the following statement:

;-----------------------------------------------------------------------------;  
TOTAL NUMBER OF POSITIONS REVISITED:                 8  
PERCENTAGE NUMBER OF POSITIONS REVISITED:       6.34921  
TOTAL NUMBER OF POSITIONS REFIT:                5.00000  
PERCENTAGE NUMBER OF POSITIONS REFIT:           62.5000  
;-----------------------------------------------------------------------------;  

Stage 7
=======

This is the final stage of the process and simply used to integrate the
solutions from stage 6 into the final solution file.

**This stage reads in the file:

'datadirectory+filename+'/STAGE_6/alternative_solutions.dat'

as input. So if you have named the 'outfile' something else in stage 6, or if
you have checked the spectra in groups (each with a unique file), the solutions
should be collected into a single file.**

;------------------------------------------------------------------------------;  
; USER INPUT  
;------------------------------------------------------------------------------;  

datadirectory = 'data directory'  
filename      = 'n2h+10_37'       ; The data cube to be analysed  
fitsfile      = filename+'.fits'  ; fits extension  
OutFile       = datadirectory+filename+'/STAGE_7/final_solns_updated.dat'  

;------------------------------------------------------------------------------;  

The output file is organised into the following columns:  

1. The number of gaussians fit
2. X position
3. Y position
4. Peak intensity
5. Uncertainty
6. Centroid velocity
7. Uncertainty
8. FWHM line-width
9. Uncertainty
10. Spectral rms
11. Residual
12. Chi-squared value
13. Number of degrees of freedom
14. Reduced Chi-squared
15. Akaike Information Criterion (AIC) value

Statistics
==========

As a final step I have run the program 'SCOUSE_extra/SCOUSE_global_stats.pro'
to immediately give us some more information on the fitting procedure. This
output the following:

Total number of positions:                      126  
Total number of positions in coverage:          126  
Number of SAAs fit:                              19  
Number of positions fit:                     107.000  
Total number of components:                     122  
Number of components per position:           1.14019  
Mean reduced chisq value:                    1.30710  
Mean sigma_resid/sigma_rms:                  1.07815  

Max intensity:                              0.982230  
Min intensity:                              0.195290  

Sigma: 0th-1st quartile:                     0.11584750      0.42895848  
Sigma: 1st-3rd quartile:                     0.42895848      0.59664214  
Sigma: 3rd-4th quartile:                     0.59664214       1.0119966  
Sigma: median:                               0.52417803  
